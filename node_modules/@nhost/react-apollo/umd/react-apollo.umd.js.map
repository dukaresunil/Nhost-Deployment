{"version":3,"file":"react-apollo.umd.js","sources":["../src/hooks.tsx","../../../node_modules/.pnpm/jwt-decode@4.0.0/node_modules/jwt-decode/build/esm/index.js","../../apollo/dist/index.esm.js","../src/provider.tsx"],"sourcesContent":["import {\n  DocumentNode,\n  OperationVariables,\n  QueryHookOptions,\n  SubscriptionHookOptions,\n  TypedDocumentNode,\n  useQuery,\n  useSubscription\n} from '@apollo/client'\nimport { useAuthenticated } from '@nhost/react'\n\nexport function useAuthQuery<\n  TData = any,\n  TVariables extends OperationVariables = OperationVariables\n>(\n  query: DocumentNode | TypedDocumentNode<TData, TVariables>,\n  options?: QueryHookOptions<TData, TVariables>\n) {\n  const isAuthenticated = useAuthenticated()\n  const newOptions = { ...options, skip: options?.skip || !isAuthenticated }\n  return useQuery(query, newOptions)\n}\n\nexport function useAuthSubscription<\n  TData = any,\n  TVariables extends OperationVariables = OperationVariables\n>(\n  subscription: DocumentNode | TypedDocumentNode<TData, TVariables>,\n  options?: SubscriptionHookOptions<TData, TVariables>\n) {\n  const isAuthenticated = useAuthenticated()\n  const newOptions: SubscriptionHookOptions<TData, TVariables> = {\n    ...options,\n    skip: options?.skip || !isAuthenticated\n  }\n\n  return useSubscription(subscription, newOptions)\n}\n\n// TODO consider other hooks\n/*\n- useAuthLazyQuery\n- useAuthMutation\n- useRoleQuery\n- useRoleLazyQuery\n- useRoleMutation\n- useRoleSubscription\n*/\n","export class InvalidTokenError extends Error {\n}\nInvalidTokenError.prototype.name = \"InvalidTokenError\";\nfunction b64DecodeUnicode(str) {\n    return decodeURIComponent(atob(str).replace(/(.)/g, (m, p) => {\n        let code = p.charCodeAt(0).toString(16).toUpperCase();\n        if (code.length < 2) {\n            code = \"0\" + code;\n        }\n        return \"%\" + code;\n    }));\n}\nfunction base64UrlDecode(str) {\n    let output = str.replace(/-/g, \"+\").replace(/_/g, \"/\");\n    switch (output.length % 4) {\n        case 0:\n            break;\n        case 2:\n            output += \"==\";\n            break;\n        case 3:\n            output += \"=\";\n            break;\n        default:\n            throw new Error(\"base64 string is not of the correct length\");\n    }\n    try {\n        return b64DecodeUnicode(output);\n    }\n    catch (err) {\n        return atob(output);\n    }\n}\nexport function jwtDecode(token, options) {\n    if (typeof token !== \"string\") {\n        throw new InvalidTokenError(\"Invalid token specified: must be a string\");\n    }\n    options || (options = {});\n    const pos = options.header === true ? 0 : 1;\n    const part = token.split(\".\")[pos];\n    if (typeof part !== \"string\") {\n        throw new InvalidTokenError(`Invalid token specified: missing part #${pos + 1}`);\n    }\n    let decoded;\n    try {\n        decoded = base64UrlDecode(part);\n    }\n    catch (e) {\n        throw new InvalidTokenError(`Invalid token specified: invalid base64 for part #${pos + 1} (${e.message})`);\n    }\n    try {\n        return JSON.parse(decoded);\n    }\n    catch (e) {\n        throw new InvalidTokenError(`Invalid token specified: invalid json for part #${pos + 1} (${e.message})`);\n    }\n}\n","import { createHttpLink as M, split as P, from as G, ApolloClient as V, InMemoryCache as g } from \"@apollo/client/core\";\nimport { setContext as H } from \"@apollo/client/link/context\";\nimport { GraphQLWsLink as U } from \"@apollo/client/link/subscriptions\";\nimport { getMainDefinition as W } from \"@apollo/client/utilities\";\nimport { jwtDecode as _ } from \"jwt-decode\";\nimport { createClient as L } from \"graphql-ws\";\nfunction R(n) {\n  let c = !1, l = () => {\n    c = !0;\n  }, p = !1, u, m;\n  const w = L({\n    ...n,\n    on: {\n      ...n.on,\n      error: (i) => {\n        var t, a;\n        console.error(i), (a = (t = n.on) == null ? void 0 : t.error) == null || a.call(t, i), l();\n      },\n      ping: (i) => {\n        i || (m = setTimeout(() => {\n          w.terminate(), l();\n        }, 5e3));\n      },\n      pong: (i) => {\n        i && clearTimeout(m);\n      },\n      opened: (i) => {\n        var t, a;\n        u = i, (a = (t = n.on) == null ? void 0 : t.opened) == null || a.call(t, u), p = !0, l = () => {\n          u.readyState === WebSocket.OPEN ? u.close(4205, \"Client Restart\") : c = !0;\n        }, c && (c = !1, l());\n      },\n      closed: (i) => {\n        var t, a;\n        (a = (t = n == null ? void 0 : n.on) == null ? void 0 : t.closed) == null || a.call(t, i), p = !1;\n      }\n    }\n  });\n  return {\n    ...w,\n    restart: () => l(),\n    isOpen: () => p\n  };\n}\nconst O = typeof window != \"undefined\", j = ({\n  nhost: n,\n  graphqlUrl: c,\n  headers: l = {},\n  publicRole: p = \"public\",\n  fetchPolicy: u,\n  cache: m = new g(),\n  connectToDevTools: w = O && process.env.NODE_ENV === \"development\",\n  onError: i,\n  link: t,\n  generateLinks: a\n}) => {\n  const N = c || (n == null ? void 0 : n.graphql.httpUrl);\n  if (!N)\n    throw Error(\"Can't initialize the Apollo Client: no backend Url has been provided\");\n  const h = N, k = n == null ? void 0 : n.auth.client.interpreter;\n  let e = null;\n  const x = () => {\n    if (!(e != null && e.value))\n      return !1;\n    const o = 3 * 1e3;\n    return _(e.value).exp * 1e3 > Date.now() - o;\n  }, E = () => !!(e != null && e.value) && !!(e != null && e.expiresAt) && (e == null ? void 0 : e.expiresAt) > /* @__PURE__ */ new Date() && x(), D = () => !e || E(), v = () => {\n    if (D())\n      return Promise.resolve();\n    const r = () => D() ? Promise.resolve(!0) : new Promise((o) => {\n      setTimeout(() => r().then(o), 100);\n    });\n    return r();\n  }, b = async () => {\n    await v();\n    const r = {\n      ...l,\n      \"Sec-WebSocket-Protocol\": \"graphql-ws\"\n    };\n    return e ? r.authorization = `Bearer ${e.value}` : r.role = p, r;\n  }, s = O ? R({\n    url: h.startsWith(\"https\") ? h.replace(/^https/, \"wss\") : h.replace(/^http/, \"ws\"),\n    shouldRetry: () => !0,\n    retryAttempts: 100,\n    retryWait: async (r) => new Promise(\n      (y) => setTimeout(\n        y,\n        1e3 * Math.pow(2, r) + Math.floor(Math.random() * 3e3)\n      )\n    ),\n    connectionParams: async () => ({\n      headers: {\n        ...l,\n        ...await b()\n      }\n    })\n  }) : null, A = s ? new U(s) : null, S = H(async (r, { headers: o }) => ({\n    headers: {\n      ...o,\n      ...await b()\n    }\n  })).concat(M({ uri: h })), C = A ? P(\n    ({ query: r }) => {\n      const o = W(r), { kind: f } = o;\n      let y;\n      return \"operation\" in o && (y = o.operation), f === \"OperationDefinition\" && y === \"subscription\";\n    },\n    A,\n    S\n  ) : S, d = [];\n  i && d.push(i), t && d.push(t), d.push(C);\n  const I = G(a ? a(d) : d), T = new V({\n    cache: m || new g(),\n    ssrMode: !O,\n    defaultOptions: {\n      watchQuery: {\n        fetchPolicy: u\n      }\n    },\n    connectToDevTools: w,\n    link: I\n  });\n  return k == null || k.onTransition(async (r, o) => {\n    if ([\"SIGNOUT\", \"SIGNED_IN\", \"TOKEN_CHANGED\"].includes(o.type)) {\n      if (o.type === \"SIGNOUT\" || o.type === \"TOKEN_CHANGED\" && r.context.accessToken.value === null) {\n        e = null;\n        try {\n          await T.resetStore();\n        } catch (f) {\n          console.error(\"Error resetting Apollo client cache\"), console.error(f);\n        }\n        return;\n      }\n      if (e = r.context.accessToken, !O || !(s != null && s.isOpen()))\n        return;\n      s == null || s.restart();\n    }\n  }), T;\n};\nexport {\n  j as createApolloClient\n};\n//# sourceMappingURL=index.esm.js.map\n","import React, { PropsWithChildren, useEffect, useState } from 'react'\n\nimport { ApolloClient, ApolloProvider, InMemoryCache } from '@apollo/client'\nimport { createApolloClient, NhostApolloClientOptions } from '@nhost/apollo'\n\n// This is needed because ApolloProvider can't be rendered without a client. To be able to render\n// the children without our client, we need an ApolloProvider because of potential underlying\n// useQuery hooks in customer applications. This way ApolloProvider and children can be rendered.\nconst mockApolloClient = new ApolloClient({ cache: new InMemoryCache() })\n\nexport const NhostApolloProvider: React.FC<PropsWithChildren<NhostApolloClientOptions>> = ({\n  children,\n  ...options\n}) => {\n  // * See https://github.com/nhost/nhost/pull/214#pullrequestreview-889730478\n  const [client, setClient] = useState<ReturnType<typeof createApolloClient>>()\n\n  // Note: Because we're using XState under the hood, we need to make sure to start the interpreter\n  // on the client side when the component is mounted. This is why we're using `useState` and\n  // `useEffect`.\n  useEffect(() => {\n    if (!client) {\n      setClient(createApolloClient(options))\n    }\n  }, [client, options])\n\n  return <ApolloProvider client={client || mockApolloClient}>{children}</ApolloProvider>\n}\n"],"names":["useAuthQuery","query","options","isAuthenticated","useAuthenticated","newOptions","useQuery","useAuthSubscription","subscription","useSubscription","InvalidTokenError","b64DecodeUnicode","str","m","p","code","base64UrlDecode","output","jwtDecode","token","pos","part","decoded","e","R","n","c","l","u","w","L","i","t","a","O","j","g","N","h","k","x","o","_","E","D","v","r","b","s","y","A","U","S","H","M","C","P","W","f","d","I","G","T","V","mockApolloClient","ApolloClient","InMemoryCache","NhostApolloProvider","children","client","setClient","useState","useEffect","createApolloClient","jsx","ApolloProvider"],"mappings":"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","x_google_ignoreList":[1]}