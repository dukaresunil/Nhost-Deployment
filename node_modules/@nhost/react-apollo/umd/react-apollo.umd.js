(function(o,p){typeof exports=="object"&&typeof module!="undefined"?p(exports,require("@apollo/client"),require("@nhost/react"),require("react/jsx-runtime"),require("react"),require("@apollo/client/core"),require("@apollo/client/link/context"),require("@apollo/client/link/subscriptions"),require("@apollo/client/utilities"),require("graphql-ws")):typeof define=="function"&&define.amd?define(["exports","@apollo/client","@nhost/react","react/jsx-runtime","react","@apollo/client/core","@apollo/client/link/context","@apollo/client/link/subscriptions","@apollo/client/utilities","graphql-ws"],p):(o=typeof globalThis!="undefined"?globalThis:o||self,p(o["@nhost/react-apollo"]={},o["@apollo/client"],o["@nhost/react"],o._jsx,o.React,o["@apollo/client/core"],o["@apollo/client/link/context"],o["@apollo/client/link/subscriptions"],o["@apollo/client/utilities"],o["graphql-ws"]))})(this,function(o,p,b,D,g,f,P,j,M,U){"use strict";function G(t,e){const n=b.useAuthenticated(),r={...e,skip:(e==null?void 0:e.skip)||!n};return p.useQuery(t,r)}function R(t,e){const n=b.useAuthenticated(),r={...e,skip:(e==null?void 0:e.skip)||!n};return p.useSubscription(t,r)}class v extends Error{}v.prototype.name="InvalidTokenError";function _(t){return decodeURIComponent(atob(t).replace(/(.)/g,(e,n)=>{let r=n.charCodeAt(0).toString(16).toUpperCase();return r.length<2&&(r="0"+r),"%"+r}))}function $(t){let e=t.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return _(e)}catch{return atob(e)}}function Q(t,e){if(typeof t!="string")throw new v("Invalid token specified: must be a string");e||(e={});const n=e.header===!0?0:1,r=t.split(".")[n];if(typeof r!="string")throw new v(`Invalid token specified: missing part #${n+1}`);let d;try{d=$(r)}catch(h){throw new v(`Invalid token specified: invalid base64 for part #${n+1} (${h.message})`)}try{return JSON.parse(d)}catch(h){throw new v(`Invalid token specified: invalid json for part #${n+1} (${h.message})`)}}function W(t){let e=!1,n=()=>{e=!0},r=!1,d,h;const m=U.createClient({...t,on:{...t.on,error:c=>{var l,u;console.error(c),(u=(l=t.on)==null?void 0:l.error)==null||u.call(l,c),n()},ping:c=>{c||(h=setTimeout(()=>{m.terminate(),n()},5e3))},pong:c=>{c&&clearTimeout(h)},opened:c=>{var l,u;d=c,(u=(l=t.on)==null?void 0:l.opened)==null||u.call(l,d),r=!0,n=()=>{d.readyState===WebSocket.OPEN?d.close(4205,"Client Restart"):e=!0},e&&(e=!1,n())},closed:c=>{var l,u;(u=(l=t==null?void 0:t.on)==null?void 0:l.closed)==null||u.call(l,c),r=!1}}});return{...m,restart:()=>n(),isOpen:()=>r}}const k=typeof window!="undefined",L=({nhost:t,graphqlUrl:e,headers:n={},publicRole:r="public",fetchPolicy:d,cache:h=new f.InMemoryCache,connectToDevTools:m=k&&process.env.NODE_ENV==="development",onError:c,link:l,generateLinks:u})=>{const C=e||(t==null?void 0:t.graphql.httpUrl);if(!C)throw Error("Can't initialize the Apollo Client: no backend Url has been provided");const A=C,E=t==null?void 0:t.auth.client.interpreter;let s=null;const K=()=>{if(!(s!=null&&s.value))return!1;const i=3*1e3;return Q(s.value).exp*1e3>Date.now()-i},B=()=>!!(s!=null&&s.value)&&!!(s!=null&&s.expiresAt)&&(s==null?void 0:s.expiresAt)>new Date&&K(),S=()=>!s||B(),J=()=>{if(S())return Promise.resolve();const i=()=>S()?Promise.resolve(!0):new Promise(a=>{setTimeout(()=>i().then(a),100)});return i()},q=async()=>{await J();const i={...n,"Sec-WebSocket-Protocol":"graphql-ws"};return s?i.authorization=`Bearer ${s.value}`:i.role=r,i},w=k?W({url:A.startsWith("https")?A.replace(/^https/,"wss"):A.replace(/^http/,"ws"),shouldRetry:()=>!0,retryAttempts:100,retryWait:async i=>new Promise(a=>setTimeout(a,1e3*Math.pow(2,i)+Math.floor(Math.random()*3e3))),connectionParams:async()=>({headers:{...n,...await q()}})}):null,x=w?new j.GraphQLWsLink(w):null,I=P.setContext(async(i,{headers:a})=>({headers:{...a,...await q()}})).concat(f.createHttpLink({uri:A})),V=x?f.split(({query:i})=>{const a=M.getMainDefinition(i),{kind:T}=a;let O;return"operation"in a&&(O=a.operation),T==="OperationDefinition"&&O==="subscription"},x,I):I,y=[];c&&y.push(c),l&&y.push(l),y.push(V);const F=f.from(u?u(y):y),N=new f.ApolloClient({cache:h||new f.InMemoryCache,ssrMode:!k,defaultOptions:{watchQuery:{fetchPolicy:d}},connectToDevTools:m,link:F});return E==null||E.onTransition(async(i,a)=>{if(["SIGNOUT","SIGNED_IN","TOKEN_CHANGED"].includes(a.type)){if(a.type==="SIGNOUT"||a.type==="TOKEN_CHANGED"&&i.context.accessToken.value===null){s=null;try{await N.resetStore()}catch(T){console.error("Error resetting Apollo client cache"),console.error(T)}return}if(s=i.context.accessToken,!k||!(w!=null&&w.isOpen()))return;w==null||w.restart()}}),N},H=new p.ApolloClient({cache:new p.InMemoryCache}),z=({children:t,...e})=>{const[n,r]=g.useState();return g.useEffect(()=>{n||r(L(e))},[n,e]),D.jsx(p.ApolloProvider,{client:n||H,children:t})};o.NhostApolloProvider=z,o.useAuthQuery=G,o.useAuthSubscription=R,Object.defineProperty(o,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=react-apollo.umd.js.map
