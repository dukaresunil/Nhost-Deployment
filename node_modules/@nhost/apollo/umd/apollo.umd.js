(function(O,R){typeof exports=="object"&&typeof module!="undefined"?R(exports,require("@apollo/client/core"),require("@apollo/client/link/context"),require("@apollo/client/link/subscriptions"),require("@apollo/client/utilities")):typeof define=="function"&&define.amd?define(["exports","@apollo/client/core","@apollo/client/link/context","@apollo/client/link/subscriptions","@apollo/client/utilities"],R):(O=typeof globalThis!="undefined"?globalThis:O||self,R(O["@nhost/apollo"]={},O["@apollo/client/core"],O["@apollo/client/link/context"],O["@apollo/client/link/subscriptions"],O["@apollo/client/utilities"]))})(this,function(O,R,oe,ie,se){"use strict";class F extends Error{}F.prototype.name="InvalidTokenError";function ae(e){return decodeURIComponent(atob(e).replace(/(.)/g,(i,p)=>{let h=p.charCodeAt(0).toString(16).toUpperCase();return h.length<2&&(h="0"+h),"%"+h}))}function ce(e){let i=e.replace(/-/g,"+").replace(/_/g,"/");switch(i.length%4){case 0:break;case 2:i+="==";break;case 3:i+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return ae(i)}catch{return atob(i)}}function le(e,i){if(typeof e!="string")throw new F("Invalid token specified: must be a string");i||(i={});const p=i.header===!0?0:1,h=e.split(".")[p];if(typeof h!="string")throw new F(`Invalid token specified: missing part #${p+1}`);let w;try{w=ce(h)}catch(f){throw new F(`Invalid token specified: invalid base64 for part #${p+1} (${f.message})`)}try{return JSON.parse(w)}catch(f){throw new F(`Invalid token specified: invalid json for part #${p+1} (${f.message})`)}}function I(e){return e===null?"null":Array.isArray(e)?"array":typeof e}function U(e){return I(e)==="object"}function ue(e){return Array.isArray(e)&&e.length>0&&e.every(i=>"message"in i)}function ee(e,i){return e.length<124?e:i}const pe="graphql-transport-ws";var N;(function(e){e[e.InternalServerError=4500]="InternalServerError",e[e.InternalClientError=4005]="InternalClientError",e[e.BadRequest=4400]="BadRequest",e[e.BadResponse=4004]="BadResponse",e[e.Unauthorized=4401]="Unauthorized",e[e.Forbidden=4403]="Forbidden",e[e.SubprotocolNotAcceptable=4406]="SubprotocolNotAcceptable",e[e.ConnectionInitialisationTimeout=4408]="ConnectionInitialisationTimeout",e[e.ConnectionAcknowledgementTimeout=4504]="ConnectionAcknowledgementTimeout",e[e.SubscriberAlreadyExists=4409]="SubscriberAlreadyExists",e[e.TooManyInitialisationRequests=4429]="TooManyInitialisationRequests"})(N||(N={}));var d;(function(e){e.ConnectionInit="connection_init",e.ConnectionAck="connection_ack",e.Ping="ping",e.Pong="pong",e.Subscribe="subscribe",e.Next="next",e.Error="error",e.Complete="complete"})(d||(d={}));function te(e){if(!U(e))throw new Error(`Message is expected to be an object, but got ${I(e)}`);if(!e.type)throw new Error("Message is missing the 'type' property");if(typeof e.type!="string")throw new Error(`Message is expects the 'type' property to be a string, but got ${I(e.type)}`);switch(e.type){case d.ConnectionInit:case d.ConnectionAck:case d.Ping:case d.Pong:{if(e.payload!=null&&!U(e.payload))throw new Error(`"${e.type}" message expects the 'payload' property to be an object or nullish or missing, but got "${e.payload}"`);break}case d.Subscribe:{if(typeof e.id!="string")throw new Error(`"${e.type}" message expects the 'id' property to be a string, but got ${I(e.id)}`);if(!e.id)throw new Error(`"${e.type}" message requires a non-empty 'id' property`);if(!U(e.payload))throw new Error(`"${e.type}" message expects the 'payload' property to be an object, but got ${I(e.payload)}`);if(typeof e.payload.query!="string")throw new Error(`"${e.type}" message payload expects the 'query' property to be a string, but got ${I(e.payload.query)}`);if(e.payload.variables!=null&&!U(e.payload.variables))throw new Error(`"${e.type}" message payload expects the 'variables' property to be a an object or nullish or missing, but got ${I(e.payload.variables)}`);if(e.payload.operationName!=null&&I(e.payload.operationName)!=="string")throw new Error(`"${e.type}" message payload expects the 'operationName' property to be a string or nullish or missing, but got ${I(e.payload.operationName)}`);if(e.payload.extensions!=null&&!U(e.payload.extensions))throw new Error(`"${e.type}" message payload expects the 'extensions' property to be a an object or nullish or missing, but got ${I(e.payload.extensions)}`);break}case d.Next:{if(typeof e.id!="string")throw new Error(`"${e.type}" message expects the 'id' property to be a string, but got ${I(e.id)}`);if(!e.id)throw new Error(`"${e.type}" message requires a non-empty 'id' property`);if(!U(e.payload))throw new Error(`"${e.type}" message expects the 'payload' property to be an object, but got ${I(e.payload)}`);break}case d.Error:{if(typeof e.id!="string")throw new Error(`"${e.type}" message expects the 'id' property to be a string, but got ${I(e.id)}`);if(!e.id)throw new Error(`"${e.type}" message requires a non-empty 'id' property`);if(!ue(e.payload))throw new Error(`"${e.type}" message expects the 'payload' property to be an array of GraphQL errors, but got ${JSON.stringify(e.payload)}`);break}case d.Complete:{if(typeof e.id!="string")throw new Error(`"${e.type}" message expects the 'id' property to be a string, but got ${I(e.id)}`);if(!e.id)throw new Error(`"${e.type}" message requires a non-empty 'id' property`);break}default:throw new Error(`Invalid message 'type' property "${e.type}"`)}return e}function de(e,i){return te(typeof e=="string"?JSON.parse(e,i):e)}function v(e,i){return te(e),JSON.stringify(e,i)}var L=function(e){return this instanceof L?(this.v=e,this):new L(e)},fe=function(e,i,p){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var h=p.apply(e,i||[]),w,f=[];return w={},P("next"),P("throw"),P("return"),w[Symbol.asyncIterator]=function(){return this},w;function P(c){h[c]&&(w[c]=function(t){return new Promise(function(M,J){f.push([c,t,M,J])>1||y(c,t)})})}function y(c,t){try{u(h[c](t))}catch(M){q(f[0][3],M)}}function u(c){c.value instanceof L?Promise.resolve(c.value.v).then(k,z):q(f[0][2],c)}function k(c){y("next",c)}function z(c){y("throw",c)}function q(c,t){c(t),f.shift(),f.length&&y(f[0][0],f[0][1])}};function ye(e){const{url:i,connectionParams:p,lazy:h=!0,onNonLazyError:w=console.error,lazyCloseTimeout:f=0,keepAlive:P=0,disablePong:y,connectionAckWaitTimeout:u=0,retryAttempts:k=5,retryWait:z=async function(l){let n=1e3;for(let o=0;o<l;o++)n*=2;await new Promise(o=>setTimeout(o,n+Math.floor(Math.random()*2700+300)))},shouldRetry:q=Y,isFatalConnectionProblem:c,on:t,webSocketImpl:M,generateID:J=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,l=>{const n=Math.random()*16|0;return(l=="x"?n:n&3|8).toString(16)})},jsonMessageReplacer:C,jsonMessageReviver:Z}=e;let _;if(M){if(!ge(M))throw new Error("Invalid WebSocket implementation provided");_=M}else typeof WebSocket!="undefined"?_=WebSocket:typeof global!="undefined"?_=global.WebSocket||global.MozWebSocket:typeof window!="undefined"&&(_=window.WebSocket||window.MozWebSocket);if(!_)throw new Error("WebSocket implementation missing; on Node you can `import WebSocket from 'ws';` and pass `webSocketImpl: WebSocket` to `createClient`");const S=_,g=(()=>{const r=(()=>{const n={};return{on(o,a){return n[o]=a,()=>{delete n[o]}},emit(o){var a;"id"in o&&((a=n[o.id])===null||a===void 0||a.call(n,o))}}})(),l={connecting:t!=null&&t.connecting?[t.connecting]:[],opened:t!=null&&t.opened?[t.opened]:[],connected:t!=null&&t.connected?[t.connected]:[],ping:t!=null&&t.ping?[t.ping]:[],pong:t!=null&&t.pong?[t.pong]:[],message:t!=null&&t.message?[r.emit,t.message]:[r.emit],closed:t!=null&&t.closed?[t.closed]:[],error:t!=null&&t.error?[t.error]:[]};return{onMessage:r.on,on(n,o){const a=l[n];return a.push(o),()=>{a.splice(a.indexOf(o),1)}},emit(n,...o){for(const a of[...l[n]])a(...o)}}})();function H(r){const l=[g.on("error",n=>{l.forEach(o=>o()),r(n)}),g.on("closed",n=>{l.forEach(o=>o()),r(n)})]}let A,$=0,K,W=!1,m=0,b=!1;async function D(){clearTimeout(K);const[r,l]=await(A!=null?A:A=new Promise((a,T)=>(async()=>{if(W){if(await z(m),!$)return A=void 0,T({code:1e3,reason:"All Subscriptions Gone"});m++}g.emit("connecting",W);const s=new S(typeof i=="function"?await i():i,pe);let G,V;function X(){isFinite(P)&&P>0&&(clearTimeout(V),V=setTimeout(()=>{s.readyState===S.OPEN&&(s.send(v({type:d.Ping})),g.emit("ping",!1,void 0))},P))}H(E=>{A=void 0,clearTimeout(G),clearTimeout(V),T(E),E instanceof ne&&(s.close(4499,"Terminated"),s.onerror=null,s.onclose=null)}),s.onerror=E=>g.emit("error",E),s.onclose=E=>g.emit("closed",E),s.onopen=async()=>{try{g.emit("opened",s);const E=typeof p=="function"?await p():p;if(s.readyState!==S.OPEN)return;s.send(v(E?{type:d.ConnectionInit,payload:E}:{type:d.ConnectionInit},C)),isFinite(u)&&u>0&&(G=setTimeout(()=>{s.close(N.ConnectionAcknowledgementTimeout,"Connection acknowledgement timeout")},u)),X()}catch(E){g.emit("error",E),s.close(N.InternalClientError,ee(E instanceof Error?E.message:new Error(E).message,"Internal client error"))}};let B=!1;s.onmessage=({data:E})=>{try{const x=de(E,Z);if(g.emit("message",x),x.type==="ping"||x.type==="pong"){g.emit(x.type,!0,x.payload),x.type==="pong"?X():y||(s.send(v(x.payload?{type:d.Pong,payload:x.payload}:{type:d.Pong})),g.emit("pong",!1,x.payload));return}if(B)return;if(x.type!==d.ConnectionAck)throw new Error(`First message cannot be of type ${x.type}`);clearTimeout(G),B=!0,g.emit("connected",s,x.payload,W),W=!1,m=0,a([s,new Promise((xe,be)=>H(be))])}catch(x){s.onmessage=null,g.emit("error",x),s.close(N.BadResponse,ee(x instanceof Error?x.message:new Error(x).message,"Bad response"))}}})()));r.readyState===S.CLOSING&&await l;let n=()=>{};const o=new Promise(a=>n=a);return[r,n,Promise.race([o.then(()=>{if(!$){const a=()=>r.close(1e3,"Normal Closure");isFinite(f)&&f>0?K=setTimeout(()=>{r.readyState===S.OPEN&&a()},f):a()}}),l])]}function j(r){if(Y(r)&&(me(r.code)||[N.InternalServerError,N.InternalClientError,N.BadRequest,N.BadResponse,N.Unauthorized,N.SubprotocolNotAcceptable,N.SubscriberAlreadyExists,N.TooManyInitialisationRequests].includes(r.code)))throw r;if(b)return!1;if(Y(r)&&r.code===1e3)return $>0;if(!k||m>=k||!q(r)||c!=null&&c(r))throw r;return W=!0}h||(async()=>{for($++;;)try{const[,,r]=await D();await r}catch(r){try{if(!j(r))return}catch(l){return w==null?void 0:w(l)}}})();function re(r,l){const n=J(r);let o=!1,a=!1,T=()=>{$--,o=!0};return(async()=>{for($++;;)try{const[s,G,V]=await D();if(o)return G();const X=g.onMessage(n,B=>{switch(B.type){case d.Next:{l.next(B.payload);return}case d.Error:{a=!0,o=!0,l.error(B.payload),T();return}case d.Complete:{o=!0,T();return}}});s.send(v({id:n,type:d.Subscribe,payload:r},C)),T=()=>{!o&&s.readyState===S.OPEN&&s.send(v({id:n,type:d.Complete},C)),$--,o=!0,G()},await V.finally(X);return}catch(s){if(!j(s))return}})().then(()=>{a||l.complete()}).catch(s=>{l.error(s)}),()=>{o||T()}}return{on:g.on,subscribe:re,iterate(r){const l=[],n={done:!1,error:null,resolve:()=>{}},o=re(r,{next(T){l.push(T),n.resolve()},error(T){n.done=!0,n.error=T,n.resolve()},complete(){n.done=!0,n.resolve()}}),a=function(){return fe(this,arguments,function*(){for(;;){for(l.length||(yield L(new Promise(G=>n.resolve=G)));l.length;)yield yield L(l.shift());if(n.error)throw n.error;if(n.done)return yield L(void 0)}})}();return a.throw=async T=>(n.done||(n.done=!0,n.error=T,n.resolve()),{done:!0,value:void 0}),a.return=async()=>(o(),{done:!0,value:void 0}),a},async dispose(){if(b=!0,A){const[r]=await A;r.close(1e3,"Normal Closure")}},terminate(){A&&g.emit("closed",new ne)}}}class ne extends Error{constructor(){super(...arguments),this.name="TerminatedCloseEvent",this.message="4499: Terminated",this.code=4499,this.reason="Terminated",this.wasClean=!1}}function Y(e){return U(e)&&"code"in e&&"reason"in e}function me(e){return[1e3,1001,1006,1005,1012,1013,1014].includes(e)?!1:e>=1e3&&e<=1999}function ge(e){return typeof e=="function"&&"constructor"in e&&"CLOSED"in e&&"CLOSING"in e&&"CONNECTING"in e&&"OPEN"in e}function he(e){let i=!1,p=()=>{i=!0},h=!1,w,f;const P=ye({...e,on:{...e.on,error:y=>{var u,k;console.error(y),(k=(u=e.on)==null?void 0:u.error)==null||k.call(u,y),p()},ping:y=>{y||(f=setTimeout(()=>{P.terminate(),p()},5e3))},pong:y=>{y&&clearTimeout(f)},opened:y=>{var u,k;w=y,(k=(u=e.on)==null?void 0:u.opened)==null||k.call(u,w),h=!0,p=()=>{w.readyState===WebSocket.OPEN?w.close(4205,"Client Restart"):i=!0},i&&(i=!1,p())},closed:y=>{var u,k;(k=(u=e==null?void 0:e.on)==null?void 0:u.closed)==null||k.call(u,y),h=!1}}});return{...P,restart:()=>p(),isOpen:()=>h}}const Q=typeof window!="undefined",we=({nhost:e,graphqlUrl:i,headers:p={},publicRole:h="public",fetchPolicy:w,cache:f=new R.InMemoryCache,connectToDevTools:P=Q&&process.env.NODE_ENV==="development",onError:y,link:u,generateLinks:k})=>{const z=i||(e==null?void 0:e.graphql.httpUrl);if(!z)throw Error("Can't initialize the Apollo Client: no backend Url has been provided");const q=z,c=e==null?void 0:e.auth.client.interpreter;let t=null;const M=()=>{if(!(t!=null&&t.value))return!1;const b=3*1e3;return le(t.value).exp*1e3>Date.now()-b},J=()=>!!(t!=null&&t.value)&&!!(t!=null&&t.expiresAt)&&(t==null?void 0:t.expiresAt)>new Date&&M(),C=()=>!t||J(),Z=()=>{if(C())return Promise.resolve();const m=()=>C()?Promise.resolve(!0):new Promise(b=>{setTimeout(()=>m().then(b),100)});return m()},_=async()=>{await Z();const m={...p,"Sec-WebSocket-Protocol":"graphql-ws"};return t?m.authorization=`Bearer ${t.value}`:m.role=h,m},S=Q?he({url:q.startsWith("https")?q.replace(/^https/,"wss"):q.replace(/^http/,"ws"),shouldRetry:()=>!0,retryAttempts:100,retryWait:async m=>new Promise(j=>setTimeout(j,1e3*Math.pow(2,m)+Math.floor(Math.random()*3e3))),connectionParams:async()=>({headers:{...p,...await _()}})}):null,g=S?new ie.GraphQLWsLink(S):null,H=oe.setContext(async(m,{headers:b})=>({headers:{...b,...await _()}})).concat(R.createHttpLink({uri:q})),A=g?R.split(({query:m})=>{const b=se.getMainDefinition(m),{kind:D}=b;let j;return"operation"in b&&(j=b.operation),D==="OperationDefinition"&&j==="subscription"},g,H):H,$=[];y&&$.push(y),u&&$.push(u),$.push(A);const K=R.from(k?k($):$),W=new R.ApolloClient({cache:f||new R.InMemoryCache,ssrMode:!Q,defaultOptions:{watchQuery:{fetchPolicy:w}},connectToDevTools:P,link:K});return c==null||c.onTransition(async(m,b)=>{if(["SIGNOUT","SIGNED_IN","TOKEN_CHANGED"].includes(b.type)){if(b.type==="SIGNOUT"||b.type==="TOKEN_CHANGED"&&m.context.accessToken.value===null){t=null;try{await W.resetStore()}catch(D){console.error("Error resetting Apollo client cache"),console.error(D)}return}if(t=m.context.accessToken,!Q||!(S!=null&&S.isOpen()))return;S==null||S.restart()}}),W};O.createApolloClient=we,Object.defineProperty(O,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=apollo.umd.js.map
