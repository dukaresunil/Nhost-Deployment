(function(M,y){typeof exports=="object"&&typeof module!="undefined"?y(exports,require("@nhost/core")):typeof define=="function"&&define.amd?define(["exports","@nhost/core"],y):(M=typeof globalThis!="undefined"?globalThis:M||self,y(M["@nhost/hasura-auth-js"]={},M.core))})(this,function(M,y){"use strict";function ne(t){this.message=t}ne.prototype=new Error,ne.prototype.name="InvalidCharacterError";var pe=typeof window!="undefined"&&window.atob&&window.atob.bind(window)||function(t){var e=String(t).replace(/=+$/,"");if(e.length%4==1)throw new ne("'atob' failed: The string to be decoded is not correctly encoded.");for(var r,n,i=0,s=0,o="";n=e.charAt(s++);~n&&(r=i%4?64*r+n:n,i++%4)?o+=String.fromCharCode(255&r>>(-2*i&6)):0)n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(n);return o};function Re(t){var e=t.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw"Illegal base64url string!"}try{return function(r){return decodeURIComponent(pe(r).replace(/(.)/g,function(n,i){var s=i.charCodeAt(0).toString(16).toUpperCase();return s.length<2&&(s="0"+s),"%"+s}))}(e)}catch{return pe(e)}}function Q(t){this.message=t}function Le(t,e){if(typeof t!="string")throw new Q("Invalid token specified");var r=(e=e||{}).header===!0?0:1;try{return JSON.parse(Re(t.split(".")[r]))}catch(n){throw new Q("Invalid token specified: "+n.message)}}Q.prototype=new Error,Q.prototype.name="InvalidTokenError";/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */var p=function(){return p=Object.assign||function(e){for(var r,n=1,i=arguments.length;n<i;n++){r=arguments[n];for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&(e[s]=r[s])}return e},p.apply(this,arguments)};function Ue(t,e){var r={};for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.indexOf(n)<0&&(r[n]=t[n]);if(t!=null&&typeof Object.getOwnPropertySymbols=="function")for(var i=0,n=Object.getOwnPropertySymbols(t);i<n.length;i++)e.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(t,n[i])&&(r[n[i]]=t[n[i]]);return r}function P(t){var e=typeof Symbol=="function"&&Symbol.iterator,r=e&&t[e],n=0;if(r)return r.call(t);if(t&&typeof t.length=="number")return{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function L(t,e){var r=typeof Symbol=="function"&&t[Symbol.iterator];if(!r)return t;var n=r.call(t),i,s=[],o;try{for(;(e===void 0||e-- >0)&&!(i=n.next()).done;)s.push(i.value)}catch(f){o={error:f}}finally{try{i&&!i.done&&(r=n.return)&&r.call(n)}finally{if(o)throw o.error}}return s}function j(t,e,r){if(r||arguments.length===2)for(var n=0,i=e.length,s;n<i;n++)(s||!(n in e))&&(s||(s=Array.prototype.slice.call(e,0,n)),s[n]=e[n]);return t.concat(s||Array.prototype.slice.call(e))}var b;(function(t){t.Start="xstate.start",t.Stop="xstate.stop",t.Raise="xstate.raise",t.Send="xstate.send",t.Cancel="xstate.cancel",t.NullEvent="",t.Assign="xstate.assign",t.After="xstate.after",t.DoneState="done.state",t.DoneInvoke="done.invoke",t.Log="xstate.log",t.Init="xstate.init",t.Invoke="xstate.invoke",t.ErrorExecution="error.execution",t.ErrorCommunication="error.communication",t.ErrorPlatform="error.platform",t.ErrorCustom="xstate.error",t.Update="xstate.update",t.Pure="xstate.pure",t.Choose="xstate.choose"})(b||(b={}));var $;(function(t){t.Parent="#_parent",t.Internal="#_internal"})($||($={}));var De=b.Start,ye=b.Stop,re=b.Raise,ie=b.Send,Me=b.Cancel;b.NullEvent;var ge=b.Assign;b.After,b.DoneState;var we=b.Log,je=b.Init;b.Invoke,b.ErrorExecution;var me=b.ErrorPlatform,ze=b.ErrorCustom,Ke=b.Update,$e=b.Choose,Ge=b.Pure,Je=".",Se={},se="xstate.guard",q=!0,Y;function be(t,e,r){r===void 0&&(r=Je);var n=xe(t,r),i=xe(e,r);return k(i)?k(n)?i===n:!1:k(n)?n in i:Object.keys(n).every(function(s){return s in i?be(n[s],i[s]):!1})}function Fe(t,e){try{return G(t)?t:t.toString().split(e)}catch{throw new Error("'".concat(t,"' is not a valid state path."))}}function He(t){return typeof t=="object"&&"value"in t&&"context"in t&&"event"in t&&"_event"in t}function xe(t,e){if(He(t))return t.value;if(G(t))return Ee(t);if(typeof t!="string")return t;var r=Fe(t,e);return Ee(r)}function Ee(t){if(t.length===1)return t[0];for(var e={},r=e,n=0;n<t.length-1;n++)n===t.length-2?r[t[n]]=t[n+1]:(r[t[n]]={},r=r[t[n]]);return e}function oe(t){var e;return(e=[]).concat.apply(e,j([],L(t),!1))}function Xe(t){return G(t)?t:[t]}function _e(t){return t===void 0?[]:Xe(t)}function Te(t,e,r){var n,i;if(x(t))return t(e,r.data);var s={};try{for(var o=P(Object.keys(t)),f=o.next();!f.done;f=o.next()){var a=f.value,l=t[a];x(l)?s[a]=l(e,r.data):s[a]=l}}catch(u){n={error:u}}finally{try{f&&!f.done&&(i=o.return)&&i.call(o)}finally{if(n)throw n.error}}return s}function Oe(t){return!!(t instanceof Promise||t!==null&&(x(t)||typeof t=="object")&&x(t.then))}function Qe(t){return t!==null&&typeof t=="object"&&"transition"in t&&typeof t.transition=="function"}function Ie(t,e,r,n){var i=t&&r.reduce(function(s,o){var f,a,l=o.assignment,u={state:n,action:o,_event:e},h={};if(x(l))h=l(s,e.data,u);else try{for(var c=P(Object.keys(l)),d=c.next();!d.done;d=c.next()){var v=d.value,w=l[v];h[v]=x(w)?w(s,e.data,u):w}}catch(S){f={error:S}}finally{try{d&&!d.done&&(a=c.return)&&a.call(c)}finally{if(f)throw f.error}}return Object.assign({},s,h)},t);return i}var ae=function(){};function G(t){return Array.isArray(t)}function x(t){return typeof t=="function"}function k(t){return typeof t=="string"}function qe(t,e){if(!!t)return k(t)?{type:se,name:t,predicate:e?e[t]:void 0}:x(t)?{type:se,name:t.name,predicate:t}:t}function Ye(t){try{return"subscribe"in t&&x(t.subscribe)}catch{return!1}}var U=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}();Y={},Y[U]=function(){return this},Y[Symbol.observable]=function(){return this};function ue(t){return!!t&&"__xstatenode"in t}function We(t){return!!t&&typeof t.send=="function"}function Pe(t,e){return k(t)||typeof t=="number"?p({type:t},e):t}function A(t,e){if(!k(t)&&"$$type"in t&&t.$$type==="scxml")return t;var r=Pe(t);return p({name:r.type,data:r,$$type:"scxml",type:"external"},e)}function Ze(t,e,r){if(!q){var n=t.stack?" Stacktrace was '".concat(t.stack,"'"):"";if(t===e)console.error("Missing onError handler for invocation '".concat(r,"', error was '").concat(t,"'.").concat(n));else{var i=e.stack?" Stacktrace was '".concat(e.stack,"'"):"";console.error("Missing onError handler and/or unhandled exception/promise rejection for invocation '".concat(r,"'. ")+"Original error: '".concat(t,"'. ").concat(n," Current error is '").concat(e,"'.").concat(i))}}}function Be(t,e,r,n,i){var s=t.options.guards,o={state:i,cond:e,_event:n};if(e.type===se)return((s==null?void 0:s[e.name])||e.predicate)(r,n.data,o);var f=s==null?void 0:s[e.type];if(!f)throw new Error("Guard '".concat(e.type,"' is not implemented on machine '").concat(t.id,"'."));return f(r,n.data,o)}function Ve(t){return typeof t=="string"?{type:t}:t}function W(t,e,r){var n=function(){},i=typeof t=="object",s=i?t:null;return{next:((i?t.next:t)||n).bind(s),error:((i?t.error:e)||n).bind(s),complete:((i?t.complete:r)||n).bind(s)}}var J=A({type:je});function fe(t,e){return e&&e[t]||void 0}function Ae(t,e){var r;if(k(t)||typeof t=="number"){var n=fe(t,e);x(n)?r={type:t,exec:n}:n?r=n:r={type:t,exec:void 0}}else if(x(t))r={type:t.name||t.toString(),exec:t};else{var n=fe(t.type,e);if(x(n))r=p(p({},t),{exec:n});else if(n){var i=n.type||t.type;r=p(p(p({},n),t),{type:i})}else r=t}return r}var ce=function(t,e){if(!t)return[];var r=G(t)?t:[t];return r.map(function(n){return Ae(n,e)})};function et(t){return{type:re,_event:A(t.event)}}function tt(t,e,r,n){var i={_event:r},s=A(x(t.event)?t.event(e,r.data,i):t.event),o;if(k(t.delay)){var f=n&&n[t.delay];o=x(f)?f(e,r.data,i):f}else o=x(t.delay)?t.delay(e,r.data,i):t.delay;var a=x(t.to)?t.to(e,r.data,i):t.to;return p(p({},t),{to:a,_event:s,event:s.data,delay:o})}var nt=function(t,e,r){return p(p({},t),{value:k(t.expr)?t.expr:t.expr(e,r.data,{_event:r})})};function rt(t,e,r){var n=x(t.activity)?t.activity(e,r.data):t.activity,i=typeof n=="string"?{id:n}:n,s={type:b.Stop,activity:i};return s}function le(t,e){var r="".concat(b.DoneInvoke,".").concat(t),n={type:r,data:e};return n.toString=function(){return r},n}function Z(t,e){var r="".concat(b.ErrorPlatform,".").concat(t),n={type:r,data:e};return n.toString=function(){return r},n}var it=function(t){var e,r,n=[];try{for(var i=P(t),s=i.next();!s.done;s=i.next())for(var o=s.value,f=0;f<o.length;){if(o[f].type===ge){n.push(o[f]),o.splice(f,1);continue}f++}}catch(a){e={error:a}}finally{try{s&&!s.done&&(r=i.return)&&r.call(i)}finally{if(e)throw e.error}}return n};function he(t,e,r,n,i,s,o){o===void 0&&(o=!1);var f=o?[]:it(i),a=f.length?Ie(r,n,f,e):r,l=o?[r]:void 0,u=[];function h(v){var w;switch(v.type){case re:return et(v);case ie:var S=tt(v,a,n,t.options.delays);return s&&S.to!==$.Internal&&u.push(S),S;case we:{var g=nt(v,a,n);return s==null||s(g,a,n),g}case $e:{var _=v,m=(w=_.conds.find(function(ke){var X=qe(ke.cond,t.options.guards);return!X||Be(t,X,a,n,s?void 0:e)}))===null||w===void 0?void 0:w.actions;if(!m)return[];var N=L(he(t,e,a,n,[ce(_e(m),t.options.actions)],s,o),2),I=N[0],R=N[1];return a=R,l==null||l.push(a),I}case Ge:{var m=v.get(a,n.data);if(!m)return[];var E=L(he(t,e,a,n,[ce(_e(m),t.options.actions)],s,o),2),C=E[0],T=E[1];return a=T,l==null||l.push(a),C}case ye:{var g=rt(v,a,n);return s==null||s(g,r,n),g}case ge:{a=Ie(a,n,[v],s?void 0:e),l==null||l.push(a);break}default:var D=Ae(v,t.options.actions),H=D.exec;if(s)s(D,a,n);else if(H&&l){var ee=l.length-1;D=p(p({},D),{exec:function(ke){for(var X=[],te=1;te<arguments.length;te++)X[te-1]=arguments[te];H.apply(void 0,j([l[ee]],L(X),!1))}})}return D}}function c(v){var w,S,g=[];try{for(var _=P(v),m=_.next();!m.done;m=_.next()){var N=m.value,I=h(N);I&&(g=g.concat(I))}}catch(R){w={error:R}}finally{try{m&&!m.done&&(S=_.return)&&S.call(_)}finally{if(w)throw w.error}}return u.forEach(function(R){s(R,a,n)}),u.length=0,g}var d=oe(i.map(c));return[d,a]}var K=function(t,e){var r=e(t);return r};function st(t){var e;return e={id:t,send:function(){},subscribe:function(){return{unsubscribe:function(){}}},getSnapshot:function(){},toJSON:function(){return{id:t}}},e[U]=function(){return this},e}function ot(t,e,r){var n=st(e);if(n.deferred=!0,ue(t)){var i=n.state=K(void 0,function(){return(r?t.withContext(r):t).initialState});n.getSnapshot=function(){return i}}return n}function at(t){try{return typeof t.send=="function"}catch{return!1}}function ut(t){return at(t)&&"id"in t}function ft(t){var e;return p((e={subscribe:function(){return{unsubscribe:function(){}}},id:"anonymous",getSnapshot:function(){}},e[U]=function(){return this},e),t)}function ct(t){return j([],L(new Set(oe(j([],L(t.map(function(e){return e.ownEvents})),!1)))),!1)}function lt(t){return t===void 0&&(t=[]),t.reduce(function(e,r){return r.meta!==void 0&&(e[r.id]=r.meta),e},{})}function ht(t){return typeof t!="object"||t===null?!1:"value"in t&&"_event"in t}function dt(t,e){var r=t.exec,n=p(p({},t),{exec:r!==void 0?function(){return r(e.context,e.event,{action:t,state:e,_event:e._event})}:void 0});return n}var Ce=function(){function t(e){var r=this,n;this.actions=[],this.activities=Se,this.meta={},this.events=[],this.value=e.value,this.context=e.context,this._event=e._event,this._sessionid=e._sessionid,this.event=this._event.data,this.historyValue=e.historyValue,this.history=e.history,this.actions=e.actions||[],this.activities=e.activities||Se,this.meta=lt(e.configuration),this.events=e.events||[],this.matches=this.matches.bind(this),this.toStrings=this.toStrings.bind(this),this.configuration=e.configuration,this.transitions=e.transitions,this.children=e.children,this.done=!!e.done,this.tags=(n=Array.isArray(e.tags)?new Set(e.tags):e.tags)!==null&&n!==void 0?n:new Set,this.machine=e.machine,Object.defineProperty(this,"nextEvents",{get:function(){return ct(r.configuration)}})}return t.from=function(e,r){if(e instanceof t)return e.context!==r?new t({value:e.value,context:r,_event:e._event,_sessionid:null,historyValue:e.historyValue,history:e.history,actions:[],activities:e.activities,meta:{},events:[],configuration:[],transitions:[],children:{}}):e;var n=J;return new t({value:e,context:r,_event:n,_sessionid:null,historyValue:void 0,history:void 0,actions:[],activities:void 0,meta:void 0,events:[],configuration:[],transitions:[],children:{}})},t.create=function(e){return new t(e)},t.inert=function(e,r){if(e instanceof t){if(!e.actions.length)return e;var n=J;return new t({value:e.value,context:r,_event:n,_sessionid:null,historyValue:e.historyValue,history:e.history,activities:e.activities,configuration:e.configuration,transitions:[],children:{}})}return t.from(e,r)},t.prototype.toStrings=function(e,r){var n=this;if(e===void 0&&(e=this.value),r===void 0&&(r="."),k(e))return[e];var i=Object.keys(e);return i.concat.apply(i,j([],L(i.map(function(s){return n.toStrings(e[s],r).map(function(o){return s+r+o})})),!1))},t.prototype.toJSON=function(){var e=this;e.configuration,e.transitions;var r=e.tags;e.machine;var n=Ue(e,["configuration","transitions","tags","machine"]);return p(p({},n),{tags:Array.from(r)})},t.prototype.matches=function(e){return be(e,this.value)},t.prototype.hasTag=function(e){return this.tags.has(e)},t.prototype.can=function(e){var r;ae(!!this.machine);var n=(r=this.machine)===null||r===void 0?void 0:r.getTransitionData(this,e);return!!(n!=null&&n.transitions.length)&&n.transitions.some(function(i){return i.target!==void 0||i.actions.length})},t}(),vt={deferEvents:!1},Ne=function(){function t(e){this.processingEvent=!1,this.queue=[],this.initialized=!1,this.options=p(p({},vt),e)}return t.prototype.initialize=function(e){if(this.initialized=!0,e){if(!this.options.deferEvents){this.schedule(e);return}this.process(e)}this.flushEvents()},t.prototype.schedule=function(e){if(!this.initialized||this.processingEvent){this.queue.push(e);return}if(this.queue.length!==0)throw new Error("Event queue should be empty when it is not processing events");this.process(e),this.flushEvents()},t.prototype.clear=function(){this.queue=[]},t.prototype.flushEvents=function(){for(var e=this.queue.shift();e;)this.process(e),e=this.queue.shift()},t.prototype.process=function(e){this.processingEvent=!0;try{e()}catch(r){throw this.clear(),r}finally{this.processingEvent=!1}},t}(),de=new Map,pt=0,B={bookId:function(){return"x:".concat(pt++)},register:function(t,e){return de.set(t,e),t},get:function(t){return de.get(t)},free:function(t){de.delete(t)}};function ve(){if(typeof globalThis!="undefined")return globalThis;if(typeof self!="undefined")return self;if(typeof window!="undefined")return window;if(typeof global!="undefined")return global;q||console.warn("XState could not find a global object in this environment. Please let the maintainers know and raise an issue here: https://github.com/statelyai/xstate/issues")}function yt(){var t=ve();if(t&&"__xstate__"in t)return t.__xstate__}function gt(t){if(!!ve()){var e=yt();e&&e.register(t)}}function wt(t,e){e===void 0&&(e={});var r=t.initialState,n=new Set,i=[],s=!1,o=function(){if(!s){for(s=!0;i.length>0;){var l=i.shift();r=t.transition(r,l,a),n.forEach(function(u){return u.next(r)})}s=!1}},f=ft({id:e.id,send:function(l){i.push(l),o()},getSnapshot:function(){return r},subscribe:function(l,u,h){var c=W(l,u,h);return n.add(c),c.next(r),{unsubscribe:function(){n.delete(c)}}}}),a={parent:e.parent,self:f,id:e.id||"anonymous",observers:n};return r=t.start?t.start(a):r,f}var mt={sync:!1,autoForward:!1},O;(function(t){t[t.NotStarted=0]="NotStarted",t[t.Running=1]="Running",t[t.Stopped=2]="Stopped"})(O||(O={}));var St=function(){function t(e,r){r===void 0&&(r=t.defaultOptions);var n=this;this.machine=e,this.delayedEventsMap={},this.listeners=new Set,this.contextListeners=new Set,this.stopListeners=new Set,this.doneListeners=new Set,this.eventListeners=new Set,this.sendListeners=new Set,this.initialized=!1,this.status=O.NotStarted,this.children=new Map,this.forwardTo=new Set,this._outgoingQueue=[],this.init=this.start,this.send=function(u,h){if(G(u))return n.batch(u),n.state;var c=A(Pe(u,h));if(n.status===O.Stopped)return n.state;if(n.status!==O.Running&&!n.options.deferEvents)throw new Error('Event "'.concat(c.name,'" was sent to uninitialized service "').concat(n.machine.id,`". Make sure .start() is called for this service, or set { deferEvents: true } in the service options.
Event: `).concat(JSON.stringify(c.data)));return n.scheduler.schedule(function(){n.forward(c);var d=n._nextState(c);n.update(d,c)}),n._state},this.sendTo=function(u,h,c){var d=n.parent&&(h===$.Parent||n.parent.id===h),v=d?n.parent:k(h)?n.children.get(h)||B.get(h):We(h)?h:void 0;if(!v){if(!d)throw new Error("Unable to send event to child '".concat(h,"' from service '").concat(n.id,"'."));return}if("machine"in v){if(n.status!==O.Stopped||n.parent!==v||n.state.done){var w=p(p({},u),{name:u.name===ze?"".concat(Z(n.id)):u.name,origin:n.sessionId});!c&&n.machine.config.predictableActionArguments?n._outgoingQueue.push([v,w]):v.send(w)}}else!c&&n.machine.config.predictableActionArguments?n._outgoingQueue.push([v,u.data]):v.send(u.data)},this._exec=function(u,h,c,d){d===void 0&&(d=n.machine.options.actions);var v=u.exec||fe(u.type,d),w=x(v)?v:v?v.exec:u.exec;if(w)try{return w(h,c.data,n.machine.config.predictableActionArguments?{action:u,_event:c}:{action:u,state:n.state,_event:c})}catch(ee){throw n.parent&&n.parent.send({type:"xstate.error",data:ee}),ee}switch(u.type){case ie:var S=u;if(typeof S.delay=="number"){n.defer(S);return}else S.to?n.sendTo(S._event,S.to,c===J):n.send(S._event);break;case Me:n.cancel(u.sendId);break;case De:{if(n.status!==O.Running)return;var g=u.activity;if(!n.machine.config.predictableActionArguments&&!n.state.activities[g.id||g.type])break;if(g.type===b.Invoke){var _=Ve(g.src),m=n.machine.options.services?n.machine.options.services[_.type]:void 0,N=g.id,I=g.data,R="autoForward"in g?g.autoForward:!!g.forward;if(!m)return;var E=I?Te(I,h,c):void 0;if(typeof m=="string")return;var C=x(m)?m(h,c.data,{data:E,src:_,meta:g.meta}):m;if(!C)return;var T=void 0;ue(C)&&(C=E?C.withContext(E):C,T={autoForward:R}),n.spawn(C,N,T)}else n.spawnActivity(g);break}case ye:{n.stopChild(u.activity.id);break}case we:var D=u.label,H=u.value;D?n.logger(D,H):n.logger(H);break}};var i=p(p({},t.defaultOptions),r),s=i.clock,o=i.logger,f=i.parent,a=i.id,l=a!==void 0?a:e.id;this.id=l,this.logger=o,this.clock=s,this.parent=f,this.options=i,this.scheduler=new Ne({deferEvents:this.options.deferEvents}),this.sessionId=B.bookId()}return Object.defineProperty(t.prototype,"initialState",{get:function(){var e=this;return this._initialState?this._initialState:K(this,function(){return e._initialState=e.machine.initialState,e._initialState})},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"state",{get:function(){return this._state},enumerable:!1,configurable:!0}),t.prototype.execute=function(e,r){var n,i;try{for(var s=P(e.actions),o=s.next();!o.done;o=s.next()){var f=o.value;this.exec(f,e,r)}}catch(a){n={error:a}}finally{try{o&&!o.done&&(i=s.return)&&i.call(s)}finally{if(n)throw n.error}}},t.prototype.update=function(e,r){var n,i,s,o,f,a,l,u,h=this;if(e._sessionid=this.sessionId,this._state=e,(!this.machine.config.predictableActionArguments||r===J)&&this.options.execute)this.execute(this.state);else for(var c=void 0;c=this._outgoingQueue.shift();)c[0].send(c[1]);if(this.children.forEach(function(T){h.state.children[T.id]=T}),this.devTools&&this.devTools.send(r.data,e),e.event)try{for(var d=P(this.eventListeners),v=d.next();!v.done;v=d.next()){var w=v.value;w(e.event)}}catch(T){n={error:T}}finally{try{v&&!v.done&&(i=d.return)&&i.call(d)}finally{if(n)throw n.error}}try{for(var S=P(this.listeners),g=S.next();!g.done;g=S.next()){var w=g.value;w(e,e.event)}}catch(T){s={error:T}}finally{try{g&&!g.done&&(o=S.return)&&o.call(S)}finally{if(s)throw s.error}}try{for(var _=P(this.contextListeners),m=_.next();!m.done;m=_.next()){var N=m.value;N(this.state.context,this.state.history?this.state.history.context:void 0)}}catch(T){f={error:T}}finally{try{m&&!m.done&&(a=_.return)&&a.call(_)}finally{if(f)throw f.error}}if(this.state.done){var I=e.configuration.find(function(T){return T.type==="final"&&T.parent===h.machine}),R=I&&I.doneData?Te(I.doneData,e.context,r):void 0;try{for(var E=P(this.doneListeners),C=E.next();!C.done;C=E.next()){var w=C.value;w(le(this.id,R))}}catch(T){l={error:T}}finally{try{C&&!C.done&&(u=E.return)&&u.call(E)}finally{if(l)throw l.error}}this._stop(),this._stopChildren()}},t.prototype.onTransition=function(e){return this.listeners.add(e),this.status===O.Running&&e(this.state,this.state.event),this},t.prototype.subscribe=function(e,r,n){var i=this,s=W(e,r,n);this.listeners.add(s.next),this.status!==O.NotStarted&&s.next(this.state);var o=function(){i.doneListeners.delete(o),i.stopListeners.delete(o),s.complete()};return this.status===O.Stopped?s.complete():(this.onDone(o),this.onStop(o)),{unsubscribe:function(){i.listeners.delete(s.next),i.doneListeners.delete(o),i.stopListeners.delete(o)}}},t.prototype.onEvent=function(e){return this.eventListeners.add(e),this},t.prototype.onSend=function(e){return this.sendListeners.add(e),this},t.prototype.onChange=function(e){return this.contextListeners.add(e),this},t.prototype.onStop=function(e){return this.stopListeners.add(e),this},t.prototype.onDone=function(e){return this.doneListeners.add(e),this},t.prototype.off=function(e){return this.listeners.delete(e),this.eventListeners.delete(e),this.sendListeners.delete(e),this.stopListeners.delete(e),this.doneListeners.delete(e),this.contextListeners.delete(e),this},t.prototype.start=function(e){var r=this;if(this.status===O.Running)return this;this.machine._init(),B.register(this.sessionId,this),this.initialized=!0,this.status=O.Running;var n=e===void 0?this.initialState:K(this,function(){return ht(e)?r.machine.resolveState(e):r.machine.resolveState(Ce.from(e,r.machine.context))});return this.options.devTools&&this.attachDev(),this.scheduler.initialize(function(){r.update(n,J)}),this},t.prototype._stopChildren=function(){this.children.forEach(function(e){x(e.stop)&&e.stop()}),this.children.clear()},t.prototype._stop=function(){var e,r,n,i,s,o,f,a,l,u;try{for(var h=P(this.listeners),c=h.next();!c.done;c=h.next()){var d=c.value;this.listeners.delete(d)}}catch(E){e={error:E}}finally{try{c&&!c.done&&(r=h.return)&&r.call(h)}finally{if(e)throw e.error}}try{for(var v=P(this.stopListeners),w=v.next();!w.done;w=v.next()){var d=w.value;d(),this.stopListeners.delete(d)}}catch(E){n={error:E}}finally{try{w&&!w.done&&(i=v.return)&&i.call(v)}finally{if(n)throw n.error}}try{for(var S=P(this.contextListeners),g=S.next();!g.done;g=S.next()){var d=g.value;this.contextListeners.delete(d)}}catch(E){s={error:E}}finally{try{g&&!g.done&&(o=S.return)&&o.call(S)}finally{if(s)throw s.error}}try{for(var _=P(this.doneListeners),m=_.next();!m.done;m=_.next()){var d=m.value;this.doneListeners.delete(d)}}catch(E){f={error:E}}finally{try{m&&!m.done&&(a=_.return)&&a.call(_)}finally{if(f)throw f.error}}if(!this.initialized)return this;this.initialized=!1,this.status=O.Stopped,this._initialState=void 0;try{for(var N=P(Object.keys(this.delayedEventsMap)),I=N.next();!I.done;I=N.next()){var R=I.value;this.clock.clearTimeout(this.delayedEventsMap[R])}}catch(E){l={error:E}}finally{try{I&&!I.done&&(u=N.return)&&u.call(N)}finally{if(l)throw l.error}}this.scheduler.clear(),this.scheduler=new Ne({deferEvents:this.options.deferEvents})},t.prototype.stop=function(){var e=this,r=this.scheduler;return this._stop(),r.schedule(function(){var n=A({type:"xstate.stop"}),i=K(e,function(){var s=oe(j([],L(e.state.configuration),!1).sort(function(u,h){return h.order-u.order}).map(function(u){return ce(u.onExit,e.machine.options.actions)})),o=L(he(e.machine,e.state,e.state.context,n,[s],e.machine.config.predictableActionArguments?e._exec:void 0,e.machine.config.predictableActionArguments||e.machine.config.preserveActionOrder),2),f=o[0],a=o[1],l=new Ce({value:e.state.value,context:a,_event:n,_sessionid:e.sessionId,historyValue:void 0,history:e.state,actions:f.filter(function(u){return u.type!==re&&(u.type!==ie||!!u.to&&u.to!==$.Internal)}),activities:{},events:[],configuration:[],transitions:[],children:{},done:e.state.done,tags:e.state.tags,machine:e.machine});return l.changed=!0,l});e.update(i,n),e._stopChildren(),B.free(e.sessionId)}),this},t.prototype.batch=function(e){var r=this;if(this.status===O.NotStarted&&this.options.deferEvents)q||ae(!1,"".concat(e.length,' event(s) were sent to uninitialized service "').concat(this.machine.id,`" and are deferred. Make sure .start() is called for this service.
Event: `).concat(JSON.stringify(event)));else if(this.status!==O.Running)throw new Error("".concat(e.length,' event(s) were sent to uninitialized service "').concat(this.machine.id,'". Make sure .start() is called for this service, or set { deferEvents: true } in the service options.'));if(!!e.length){var n=!!this.machine.config.predictableActionArguments&&this._exec;this.scheduler.schedule(function(){var i,s,o=r.state,f=!1,a=[],l=function(d){var v=A(d);r.forward(v),o=K(r,function(){return r.machine.transition(o,v,void 0,n||void 0)}),a.push.apply(a,j([],L(r.machine.config.predictableActionArguments?o.actions:o.actions.map(function(w){return dt(w,o)})),!1)),f=f||!!o.changed};try{for(var u=P(e),h=u.next();!h.done;h=u.next()){var c=h.value;l(c)}}catch(d){i={error:d}}finally{try{h&&!h.done&&(s=u.return)&&s.call(u)}finally{if(i)throw i.error}}o.changed=f,o.actions=a,r.update(o,A(e[e.length-1]))})}},t.prototype.sender=function(e){return this.send.bind(this,e)},t.prototype._nextState=function(e,r){var n=this;r===void 0&&(r=!!this.machine.config.predictableActionArguments&&this._exec);var i=A(e);if(i.name.indexOf(me)===0&&!this.state.nextEvents.some(function(o){return o.indexOf(me)===0}))throw i.data.data;var s=K(this,function(){return n.machine.transition(n.state,i,void 0,r||void 0)});return s},t.prototype.nextState=function(e){return this._nextState(e,!1)},t.prototype.forward=function(e){var r,n;try{for(var i=P(this.forwardTo),s=i.next();!s.done;s=i.next()){var o=s.value,f=this.children.get(o);if(!f)throw new Error("Unable to forward event '".concat(e,"' from interpreter '").concat(this.id,"' to nonexistant child '").concat(o,"'."));f.send(e)}}catch(a){r={error:a}}finally{try{s&&!s.done&&(n=i.return)&&n.call(i)}finally{if(r)throw r.error}}},t.prototype.defer=function(e){var r=this;this.delayedEventsMap[e.id]=this.clock.setTimeout(function(){e.to?r.sendTo(e._event,e.to,!0):r.send(e._event)},e.delay)},t.prototype.cancel=function(e){this.clock.clearTimeout(this.delayedEventsMap[e]),delete this.delayedEventsMap[e]},t.prototype.exec=function(e,r,n){n===void 0&&(n=this.machine.options.actions),this._exec(e,r.context,r._event,n)},t.prototype.removeChild=function(e){var r;this.children.delete(e),this.forwardTo.delete(e),(r=this.state)===null||r===void 0||delete r.children[e]},t.prototype.stopChild=function(e){var r=this.children.get(e);!r||(this.removeChild(e),x(r.stop)&&r.stop())},t.prototype.spawn=function(e,r,n){if(this.status!==O.Running)return ot(e,r);if(Oe(e))return this.spawnPromise(Promise.resolve(e),r);if(x(e))return this.spawnCallback(e,r);if(ut(e))return this.spawnActor(e,r);if(Ye(e))return this.spawnObservable(e,r);if(ue(e))return this.spawnMachine(e,p(p({},n),{id:r}));if(Qe(e))return this.spawnBehavior(e,r);throw new Error('Unable to spawn entity "'.concat(r,'" of type "').concat(typeof e,'".'))},t.prototype.spawnMachine=function(e,r){var n=this;r===void 0&&(r={});var i=new t(e,p(p({},this.options),{parent:this,id:r.id||e.id})),s=p(p({},mt),r);s.sync&&i.onTransition(function(f){n.send(Ke,{state:f,id:i.id})});var o=i;return this.children.set(i.id,o),s.autoForward&&this.forwardTo.add(i.id),i.onDone(function(f){n.removeChild(i.id),n.send(A(f,{origin:i.id}))}).start(),o},t.prototype.spawnBehavior=function(e,r){var n=wt(e,{id:r,parent:this});return this.children.set(r,n),n},t.prototype.spawnPromise=function(e,r){var n,i=this,s=!1,o;e.then(function(a){s||(o=a,i.removeChild(r),i.send(A(le(r,a),{origin:r})))},function(a){if(!s){i.removeChild(r);var l=Z(r,a);try{i.send(A(l,{origin:r}))}catch(u){Ze(a,u,r),i.devTools&&i.devTools.send(l,i.state),i.machine.strict&&i.stop()}}});var f=(n={id:r,send:function(){},subscribe:function(a,l,u){var h=W(a,l,u),c=!1;return e.then(function(d){c||(h.next(d),!c&&h.complete())},function(d){c||h.error(d)}),{unsubscribe:function(){return c=!0}}},stop:function(){s=!0},toJSON:function(){return{id:r}},getSnapshot:function(){return o}},n[U]=function(){return this},n);return this.children.set(r,f),f},t.prototype.spawnCallback=function(e,r){var n,i=this,s=!1,o=new Set,f=new Set,a,l=function(c){a=c,f.forEach(function(d){return d(c)}),!s&&i.send(A(c,{origin:r}))},u;try{u=e(l,function(c){o.add(c)})}catch(c){this.send(Z(r,c))}if(Oe(u))return this.spawnPromise(u,r);var h=(n={id:r,send:function(c){return o.forEach(function(d){return d(c)})},subscribe:function(c){var d=W(c);return f.add(d.next),{unsubscribe:function(){f.delete(d.next)}}},stop:function(){s=!0,x(u)&&u()},toJSON:function(){return{id:r}},getSnapshot:function(){return a}},n[U]=function(){return this},n);return this.children.set(r,h),h},t.prototype.spawnObservable=function(e,r){var n,i=this,s,o=e.subscribe(function(a){s=a,i.send(A(a,{origin:r}))},function(a){i.removeChild(r),i.send(A(Z(r,a),{origin:r}))},function(){i.removeChild(r),i.send(A(le(r),{origin:r}))}),f=(n={id:r,send:function(){},subscribe:function(a,l,u){return e.subscribe(a,l,u)},stop:function(){return o.unsubscribe()},getSnapshot:function(){return s},toJSON:function(){return{id:r}}},n[U]=function(){return this},n);return this.children.set(r,f),f},t.prototype.spawnActor=function(e,r){return this.children.set(r,e),e},t.prototype.spawnActivity=function(e){var r=this.machine.options&&this.machine.options.activities?this.machine.options.activities[e.type]:void 0;if(!r){q||ae(!1,"No implementation found for activity '".concat(e.type,"'"));return}var n=r(this.state.context,e);this.spawnEffect(e.id,n)},t.prototype.spawnEffect=function(e,r){var n;this.children.set(e,(n={id:e,send:function(){},subscribe:function(){return{unsubscribe:function(){}}},stop:r||void 0,getSnapshot:function(){},toJSON:function(){return{id:e}}},n[U]=function(){return this},n))},t.prototype.attachDev=function(){var e=ve();if(this.options.devTools&&e){if(e.__REDUX_DEVTOOLS_EXTENSION__){var r=typeof this.options.devTools=="object"?this.options.devTools:void 0;this.devTools=e.__REDUX_DEVTOOLS_EXTENSION__.connect(p(p({name:this.id,autoPause:!0,stateSanitizer:function(n){return{value:n.value,context:n.context,actions:n.actions}}},r),{features:p({jump:!1,skip:!1},r?r.features:void 0)}),this.machine),this.devTools.init(this.state)}gt(this)}},t.prototype.toJSON=function(){return{id:this.id}},t.prototype[U]=function(){return this},t.prototype.getSnapshot=function(){return this.status===O.NotStarted?this.initialState:this._state},t.defaultOptions={execute:!0,deferEvents:!0,clock:{setTimeout:function(e,r){return setTimeout(e,r)},clearTimeout:function(e){return clearTimeout(e)}},logger:console.log.bind(console),devTools:!1},t.interpret=F,t}();function F(t,e){var r=new St(t,e);return r}const bt=()=>typeof window!="undefined",V=t=>!t||!t.accessToken.value||!t.refreshToken.value||!t.accessToken.expiresAt||!t.user?null:{accessToken:t.accessToken.value,accessTokenExpiresIn:(t.accessToken.expiresAt.getTime()-Date.now())/1e3,refreshToken:t.refreshToken.value,user:t.user},z=({accessToken:t,isError:e,user:r,error:n})=>e?{session:null,error:n}:r&&t?{session:{accessToken:t,accessTokenExpiresIn:0,refreshToken:"",user:r},error:null}:{session:null,error:null};class xt{constructor({url:e,autoRefreshToken:r=!0,autoSignIn:n=!0,autoLogin:i,clientStorage:s,clientStorageType:o,clientStorageGetter:f,clientStorageSetter:a,refreshIntervalTime:l,start:u=!0}){var h;this.url=e,this._client=new y.AuthClient({backendUrl:e,clientUrl:typeof window!="undefined"&&((h=window.location)==null?void 0:h.origin)||"",autoRefreshToken:r,autoSignIn:typeof i=="boolean"?i:n,start:u,clientStorage:s,clientStorageType:o,clientStorageGetter:f,clientStorageSetter:a,refreshIntervalTime:l})}async signUp(e){const r=await this.waitUntilReady(),{email:n,options:i}=e;return"securityKey"in e?z(await y.signUpEmailSecurityKeyPromise(r,n,i)):z(await y.signUpEmailPasswordPromise(r,n,e.password,i))}async signIn(e){const r=await this.waitUntilReady();if(!e){const n=await y.signInAnonymousPromise(r);return{...z(n),mfa:null}}if("provider"in e){const{provider:n,options:i}=e,s=y.encodeQueryParameters(`${this._client.backendUrl}/signin/provider/${n}`,y.rewriteRedirectTo(this._client.clientUrl,i));return bt()&&(window.location.href=s),{providerUrl:s,provider:n,session:null,mfa:null,error:null}}if("email"in e&&"password"in e){const n=await y.signInEmailPasswordPromise(r,e.email,e.password);return n.needsEmailVerification?{session:null,mfa:null,error:y.EMAIL_NEEDS_VERIFICATION}:n.needsMfaOtp?{session:null,mfa:n.mfa,error:null}:{...z(n),mfa:null}}if("email"in e&&"securityKey"in e){if(e.securityKey!==!0)throw Error("securityKey must be true");const n=await y.signInEmailSecurityKeyPromise(r,e.email);return{...z(n),mfa:null}}if("email"in e){const{email:n,options:i}=e,{error:s}=await y.signInEmailPasswordlessPromise(r,n,i);return{session:null,mfa:null,error:s}}if("phoneNumber"in e&&"otp"in e){const n=await y.signInSmsPasswordlessOtpPromise(r,e.phoneNumber,e.otp);return{...z(n),mfa:null}}if("phoneNumber"in e){const{error:n}=await y.signInSmsPasswordlessPromise(r,e.phoneNumber,e.options);return{error:n,mfa:null,session:null}}if("otp"in e){const n=await y.signInMfaTotpPromise(r,e.otp,e.ticket);return{...z(n),mfa:null}}return{error:y.INVALID_SIGN_IN_METHOD,mfa:null,session:null}}async signOut(e){const r=await this.waitUntilReady(),{error:n}=await y.signOutPromise(r,e==null?void 0:e.all);return{error:n}}async resetPassword({email:e,options:r}){const n=F(y.createResetPasswordMachine(this._client)).start(),{error:i}=await y.resetPasswordPromise(n,e,r);return{error:i}}async changePassword({newPassword:e,ticket:r}){const n=F(y.createChangePasswordMachine(this._client)).start(),{error:i}=await y.changePasswordPromise(n,e,r);return{error:i}}async sendVerificationEmail({email:e,options:r}){const n=F(y.createSendVerificationEmailMachine(this._client)).start(),{error:i}=await y.sendVerificationEmailPromise(n,e,r);return{error:i}}async changeEmail({newEmail:e,options:r}){const n=F(y.createChangeEmailMachine(this._client)).start(),{error:i}=await y.changeEmailPromise(n,e,r);return{error:i}}async deanonymize(e){const r=await this.waitUntilReady();if(e.signInMethod==="passwordless"){if(e.connection==="email"){const{error:n}=await y.signInEmailPasswordlessPromise(r,e.email,e.options);return{error:n}}if(e.connection==="sms"){const{error:n}=await y.signInSmsPasswordlessPromise(r,e.phoneNumber,e.options);return{error:n}}}if(e.signInMethod==="email-password"){const{error:n}=await y.signUpEmailPasswordPromise(r,e.email,e.password,e.options);return{error:n}}throw Error("Unknown deanonymization method")}async addSecurityKey(e){const{error:r,key:n}=await y.addSecurityKeyPromise(this._client,e);return{error:r,key:n}}onTokenChanged(e){const r=n=>n.onTransition(({event:i,context:s})=>{i.type==="TOKEN_CHANGED"&&e(V(s))});if(this._client.interpreter){const n=r(this._client.interpreter);return()=>n.stop()}else return this._client.onStart(n=>{r(n.interpreter)}),()=>{console.log("onTokenChanged was added before the interpreter started. Cannot unsubscribe listener.")}}onAuthStateChanged(e){const r=n=>n.onTransition(({event:i,context:s})=>{(i.type==="SIGNED_IN"||i.type==="SIGNED_OUT")&&e(i.type,V(s))});if(this._client.interpreter){const n=r(this._client.interpreter);return()=>n.stop()}else return this._client.onStart(n=>{r(n.interpreter)}),()=>{console.log("onAuthStateChanged was added before the interpreter started. Cannot unsubscribe listener.")}}isAuthenticated(){var e;return!!((e=this._client.interpreter)!=null&&e.state.matches({authentication:"signedIn"}))}async isAuthenticatedAsync(){return(await this.waitUntilReady()).state.matches({authentication:"signedIn"})}getAuthenticationStatus(){var r;const e=((r=this.client.interpreter)==null?void 0:r.getSnapshot().context.importTokenAttempts)||0;return this.isReady()?{isAuthenticated:this.isAuthenticated(),isLoading:!1,connectionAttempts:e}:{isAuthenticated:!1,isLoading:!0,connectionAttempts:e}}getJWTToken(){return this.getAccessToken()}getAccessToken(){var e,r;return(r=(e=this._client.interpreter)==null?void 0:e.state.context.accessToken.value)!=null?r:void 0}getDecodedAccessToken(){const e=this.getAccessToken();return e?Le(e):null}getHasuraClaims(){var e;return((e=this.getDecodedAccessToken())==null?void 0:e["https://hasura.io/jwt/claims"])||null}getHasuraClaim(e){var r;return((r=this.getHasuraClaims())==null?void 0:r[e.startsWith("x-hasura-")?e:`x-hasura-${e}`])||null}async refreshSession(e){try{const r=await this.waitUntilReady();return new Promise(n=>{const i=e||r.state.context.refreshToken.value;if(!i)return n({session:null,error:y.NO_REFRESH_TOKEN});const{changed:s}=r.send("TRY_TOKEN",{token:i});if(!s)return n({session:null,error:y.TOKEN_REFRESHER_RUNNING_ERROR});r.onTransition(o=>{o.matches({token:{idle:"error"}})?n({session:null,error:y.INVALID_REFRESH_TOKEN}):o.event.type==="TOKEN_CHANGED"&&n({session:V(o.context),error:null})})})}catch(r){return{session:null,error:r.message}}}getSession(){var e,r;return V((r=(e=this._client.interpreter)==null?void 0:e.state)==null?void 0:r.context)}getUser(){var e,r,n;return((n=(r=(e=this._client.interpreter)==null?void 0:e.state)==null?void 0:r.context)==null?void 0:n.user)||null}waitUntilReady(){const r=this._client.interpreter;if(!r)throw Error("Auth interpreter not set");return r.state.hasTag("loading")?new Promise((n,i)=>{let s=setTimeout(()=>i(`The state machine is not yet ready after ${15} seconds.`),15e3);r.onTransition(o=>{if(!o.hasTag("loading"))return clearTimeout(s),n(r)})}):Promise.resolve(r)}isReady(){var e,r;return!((r=(e=this._client.interpreter)==null?void 0:e.state)!=null&&r.hasTag("loading"))}get client(){return this._client}}M.HasuraAuthClient=xt,Object.defineProperties(M,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
//# sourceMappingURL=hasura-auth-js.umd.js.map
